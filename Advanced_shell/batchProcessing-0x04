#!/usr/bin/env bash
# get data in parallel using background processes and process management

set -euo pipefail

DATA_DIR="pokemon_data"
ERROR_LOG="errors.txt"
BASE_URL="https://pokeapi.co/api/v2/pokemon"
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

mkdir -p "$DATA_DIR"
> "$ERROR_LOG"

echo "Starting data collection"

fetch_pokemon() {
  local name="$1"
  local outfile="${DATA_DIR}/${name}.json"
  local url="${BASE_URL}/${name}"

  echo "Fetching ${name}..."
  response_code=$(curl -s -o "$outfile" -w "%{http_code}" "$url")

  if [[ "$response_code" -eq 200 ]]; then
    echo "Saved data to ${outfile}"
  else
    echo "$(date '+%Y-%m-%d %H:%M:%S') ERROR: Failed to fetch ${name} (HTTP ${response_code})" >> "$ERROR_LOG"
    rm -f "$outfile"
    echo "Failed to fetch ${name}"
  fi
}

#launch fetches in background
for pokemon in "${POKEMON_LIST[@]}"; do
  fetch_pokemon "$pokemon" &
done

#show running background tasks
echo ""
echo "Active background jobs:"
jobs

#wait for background tasks to complete
wait
echo ""
echo "All background jobs have completed."


#in case of runaway jobs, stop
if jobs -r > /dev/null; then
  echo "No hanging jobs detected. If there were, weâ€™d clean them up using kill."
else
  echo "Cleaning up (simulated):"
  fake_pid=9999
  kill -0 $fake_pid 2>/dev/null || true
fi

echo ""
echo "Batch processing complete. Check errors.txt for any issues."
